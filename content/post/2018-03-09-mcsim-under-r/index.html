---
title: 'MCSim under R'
summary: Run GNU MCSim (under R) in Windows system
authors:
- admin
date: "2018-03-09"
output:
  blogdown::html_page:
    toc: true
    toc_depth: 2
projects: [PBPK]
categories: [software]
tags: [mcsim, R]

# Featured image
# To use, add an image named `featured.jpg/png` to your page's folder.
# Placement options: 1 = Full column width, 2 = Out-set, 3 = Screen-width
# Focal point options: Smart, Center, TopLeft, Top, TopRight, Left, Right, BottomLeft, Bottom, BottomRight  
# image:
#  placement: 2
#  preview_only: true
#  focal_point: 'TopRight'
#  caption: 'Image credit: [**Unsplash**](https://unsplash.com/photos/CpkOjOcXdUY)'

---


<div id="TOC">
<ul>
<li><a href="#introduction">Introduction</a><ul>
<li><a href="#create-gnu-mcsim-program">Create <strong>GNU MCSim</strong> program</a></li>
</ul></li>
<li><a href="#r-package-desolve-solution">R package <strong>deSolve</strong> solution</a><ul>
<li><a href="#solve-ode-in-pure-r">Solve ODE in pure R</a></li>
<li><a href="#use-desolve-with-gnu-mcsim-model-file">Use <strong>deSolve</strong> with <strong>GNU MCSim</strong> model file</a></li>
</ul></li>
<li><a href="#gnu-mcsim-solution"><strong>GNU MCSim</strong> solution</a></li>
<li><a href="#session-info">Session info</a></li>
</ul>
</div>

<p>{{% alert note %}}
<strong><strong>The post was updated on 2019-12-31 under Windows 10 x64.</strong></strong>
{{% /alert %}}</p>
<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>Using <strong>GNU MCSim</strong> under Windows is more complicated than the Unix-like System, such as macOS and Linux. Also, it does not provide the function to analyze and visualize the output result. Therefore, I write this post to demo how to run <strong>GNU MCSim</strong> under Windows OS and conduct the follow-up analysis with R. This exercise was sourced from the file <a href="https://www.gnu.org/software/mcsim/mcsim_under_R.zip"><strong>MCSim under R</strong></a> in <a href="https://www.gnu.org/software/mcsim/"><strong>GNU MCSim</strong></a>.</p>
<p>In this post, I used <strong>Rtools</strong> (v3.5) which has some essential set of Unix/Linux tools to conduct the model compilation. Also, the <strong>GNU MCSim</strong> (v6.1.0) is used to do the following modeling and simulation works. The portable version are put in my GitHub repo (<a href="https://github.com/nanhung/MinGM" class="uri">https://github.com/nanhung/MinGM</a>)</p>
<pre class="r"><code>wd &lt;- getwd()
url &lt;- &quot;https://github.com/nanhung/MinGM/archive/v6.1.0.zip&quot;
tf &lt;- tempfile()
download.file(url, tf, mode = &quot;wb&quot;)
unzip(zipfile = tf, exdir = wd)</code></pre>
<p>If you have installed <code>devtools</code> you can use <code>devtools::find_rtools()</code> to check the avaliable of Rtools.</p>
<pre class="r"><code>devtools::find_rtools()</code></pre>
<pre><code>## [1] TRUE</code></pre>
<p>Also, we need to chek the Rtools is in the PATH by using</p>
<pre class="r"><code>Sys.getenv(&quot;PATH&quot;)</code></pre>
<pre><code>## [1] &quot;C:\\Program Files\\R\\R-3.6.2\\bin\\x64;C:\\Windows\\system32;C:\\Windows;C:\\Windows\\System32\\Wbem;C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\;C:\\Windows\\System32\\OpenSSH\\;C:\\Program Files\\NVIDIA Corporation\\NVIDIA NvDLISR;C:\\Program Files\\Git\\cmd;C:\\Users\\nan_1\\AppData\\Local\\Microsoft\\WindowsApps;;C:\\Users\\nan_1\\AppData\\Local\\Programs\\Microsoft VS Code\\bin&quot;</code></pre>
<p>If you can not find the Rtools in the PATH. such as, <code>c:\\Rtools\\bin</code> and <code>c:\\Rtools\\mingw_64\\bin</code>. You will need to manually add it as follow,</p>
<pre class="r"><code>Sys.setenv(PATH = paste(&quot;c:\\Rtools\\bin&quot;, Sys.getenv(&quot;PATH&quot;), sep=&quot;;&quot;))
Sys.setenv(PATH = paste(&quot;c:\\Rtools\\mingw_64\\bin&quot;, Sys.getenv(&quot;PATH&quot;), sep=&quot;;&quot;))</code></pre>
<p>Then, use following command to check the function.</p>
<pre class="r"><code>Sys.which(&quot;gcc&quot;)</code></pre>
<pre><code>##                                  gcc 
## &quot;c:\\Rtools\\mingw_64\\bin\\gcc.exe&quot;</code></pre>
<pre class="r"><code>Sys.which(&quot;make&quot;)</code></pre>
<pre><code>##                        make 
## &quot;c:\\Rtools\\bin\\make.exe&quot;</code></pre>
<div id="create-gnu-mcsim-program" class="section level2">
<h2>Create <strong>GNU MCSim</strong> program</h2>
<p>The following steps is used to generate the executable program (<code>mod.exe</code>) that can traslate the format of model code to C.</p>
<pre class="r"><code>libSBML = &quot;&quot; # libSBML = &quot;-lsbml&quot; 
# uncomment and execute if you have and want to use libSBML.

# create mod.exe in &quot;mod&quot; folder
system(paste(&quot;gcc -o MinGM-6.1.0/mod.exe MinGM-6.1.0/mod/*.c &quot;, libSBML, sep = &quot;&quot;)) </code></pre>
<p><strong>NOTE:</strong> In this case, we don’t need to load libSBML. Therefore, check the <code>config.h</code> file in mod folder. We can see the line 26 in the config.h file like <a href="https://github.com/rbind/nanhung.me/blob/master/content/post/mod/config.h">THIS</a>. The <code>#define HAVE_LIBSBML 1</code> had been disabled. It can prevent the problem when compile to the mod.exe file. (Thanks <strong>Yu-Sheng Lin</strong> for provding this issue; Mar. 23, 2018).</p>
<p>Finally, check if we successfully generate the program <code>mod.exe</code>.</p>
<pre class="r"><code>file.exists(&quot;MinGM-6.1.0/mod.exe&quot;)</code></pre>
<pre><code>## [1] TRUE</code></pre>
<p>If everything is going well, we can move on to next section.</p>
</div>
</div>
<div id="r-package-desolve-solution" class="section level1">
<h1>R package <strong>deSolve</strong> solution</h1>
<div id="solve-ode-in-pure-r" class="section level2">
<h2>Solve ODE in pure R</h2>
<p>This section is a demo of solving the ODE in R environment with <strong>deSolve</strong> package.</p>
<pre class="r"><code># Load deSolve package
library(deSolve)</code></pre>
<pre class="r"><code># Create the ODE function based on the **deSolve** format
model &lt;- function(t, Y, parameters) {
  with (as.list(parameters), {
    dy1 = -k1*Y[1] + k2*Y[2]*Y[3];
    dy3 = k3*Y[2]*Y[2];
    dy2 = -dy1 - dy3;
    list(c(dy1, dy2, dy3));
    })
}
jac &lt;- function (t, Y, parameters) {
  with (as.list(parameters), {
       PD[1,1] &lt;- -k1;
       PD[1,2] &lt;- k2*Y[3];
       PD[1,3] &lt;- k2*Y[2];
       PD[2,1] &lt;- k1;
       PD[2,3] &lt;- -PD[1,3];
       PD[3,2] &lt;- k3*Y[2];
       PD[2,2] &lt;- -PD[1,2] - PD[3,2];

       return(PD) 
    }) 
}</code></pre>
<pre class="r"><code># Define the parameter values and some conditions
parms &lt;- c(k1 = 0.04, k2 = 1e4, k3=3e7) # parameter values
Y &lt;- c(y1 = 1.0, y2 = 0.0, y3 = 0.0) # Initial conditions
times  &lt;- c(0, 0.4*10^(0:11)) # Time steps
PD &lt;- matrix(nrow = 3, ncol = 3, data = 0)</code></pre>
<pre class="r"><code># Solve ODE 
out.1 &lt;- ode(Y, times, model, parms = parms, jacfunc = jac)
head(out.1)</code></pre>
<pre><code>##       time        y1           y2         y3
## [1,] 0e+00 1.0000000 0.000000e+00 0.00000000
## [2,] 4e-01 0.9851723 3.386399e-05 0.01479384
## [3,] 4e+00 0.9055179 2.240437e-05 0.09445974
## [4,] 4e+01 0.7158298 9.185501e-06 0.28416101
## [5,] 4e+02 0.4505174 3.222887e-06 0.54947938
## [6,] 4e+03 0.1831994 8.942298e-07 0.81679972</code></pre>
<pre class="r"><code># Visualization
plot(out.1,type=&quot;b&quot;,log=&quot;x&quot;)</code></pre>
<pre><code>## Warning in xy.coords(x, y, xlabel, ylabel, log): 1 x value &lt;= 0 omitted from
## logarithmic plot

## Warning in xy.coords(x, y, xlabel, ylabel, log): 1 x value &lt;= 0 omitted from
## logarithmic plot

## Warning in xy.coords(x, y, xlabel, ylabel, log): 1 x value &lt;= 0 omitted from
## logarithmic plot</code></pre>
<p><img src="/post/2018-03-09-mcsim-under-r/index_files/figure-html/unnamed-chunk-13-1.png" width="672" /></p>
</div>
<div id="use-desolve-with-gnu-mcsim-model-file" class="section level2">
<h2>Use <strong>deSolve</strong> with <strong>GNU MCSim</strong> model file</h2>
<p>Here, we want to use model code that was based on the GNU MCSim format. The model code look like following format,</p>
<pre><code>##################
## simple.model ##
##################

States = {y0, y1, y2};
Outputs = {yout};

# Parameters
k1 = 1;
k2 = 1;
k3 = 1;

Dynamics {

  dt(y0) = -k1 * y0 + k2 * y1 * y2; 
  dt(y2) =  k3 * y1 * y1; 
  dt(y1) = -dt(y0) - dt(y2);

  yout = y0 + y1 + y2;

} 

Events {
  y0 = 1;
}

Roots { # here we need inlining, otherwise &#39;gout&#39; will not be understood 
  Inline ( gout[0] = y[0] - 0.5; );
}

End.</code></pre>
<p>First, we need to create model script that is based on C (<code>simple.model.c</code>) and generate initialization file (<code>simple.model_inits.R</code>).</p>
<pre class="r"><code>system(&quot;MinGM-6.1.0/mod.exe -R simple.model simple.model.c&quot;) </code></pre>
<pre class="r"><code># create simple.model.o and simple.model.dll files
system (&quot;R CMD SHLIB simple.model.c&quot;) 

# load simple.model.dll
dyn.load(paste(&quot;simple.model&quot;, .Platform$dynlib.ext, sep=&quot;&quot;)) </code></pre>
<p>Note, the compile the GNU MCSim model, needs to be done each time you modify the model.</p>
<pre class="r"><code>source (&quot;simple.model_inits.R&quot;)

# define parameter values
parms_init &lt;- initParms () 

# define initial state values
Y_init &lt;- initStates (parms) 

# set output times, time 0 must be given
times &lt;- c(0, 4e-1, 4e+0, 4e+1, 4e+2, 4e+3, 4e+4, 4e+5, 4e+6, 4e+7, 4e+8, 4e+9)</code></pre>
<pre class="r"><code>out.2.1 &lt;- ode(Y_init, times, func = &quot;derivs&quot;, parms = parms_init, 
               jacfunc = &quot;jac&quot;, dllname = &quot;simple.model&quot;, 
               initfunc = &quot;initmod&quot;, nout = 1, outnames = &quot;Sum&quot;)

plot(out.2.1, log=&quot;x&quot;, type=&quot;b&quot;)</code></pre>
<pre><code>## Warning in xy.coords(x, y, xlabel, ylabel, log): 1 x value &lt;= 0 omitted from
## logarithmic plot

## Warning in xy.coords(x, y, xlabel, ylabel, log): 1 x value &lt;= 0 omitted from
## logarithmic plot

## Warning in xy.coords(x, y, xlabel, ylabel, log): 1 x value &lt;= 0 omitted from
## logarithmic plot

## Warning in xy.coords(x, y, xlabel, ylabel, log): 1 x value &lt;= 0 omitted from
## logarithmic plot</code></pre>
<p><img src="/post/2018-03-09-mcsim-under-r/index_files/figure-html/unnamed-chunk-17-1.png" width="672" /></p>
<p>{{% alert note %}}
We can’t find any change in the dynamic process. It is due to the all initial value equal to 0.<br />
{{% /alert %}}</p>
<pre class="r"><code>parms_init</code></pre>
<pre><code>## k1 k2 k3 
##  1  1  1</code></pre>
<pre class="r"><code>Y_init</code></pre>
<pre><code>## y0 y1 y2 
##  0  0  0</code></pre>
<div id="parameters-and-initial-values" class="section level3">
<h3>Parameters and initial values</h3>
<p>Since the parameters and initial state values should define before simulation, we need to use the following code to assign them.</p>
<pre class="r"><code># Define the parameters and initial values
parms &lt;- c(k1 = 0.04, k2 = 1e4, k3=3e7) 
Y &lt;- c(y0 = 1.0, y1 = 0.0, y2 = 0.0)

# Use the defined parameters and initial values
out.2.2 &lt;- ode(Y, times, func = &quot;derivs&quot;, parms = parms,
               dllname = &quot;simple.model&quot;, initfunc = &quot;initmod&quot;,
               nout = 1, outnames = &quot;Sum&quot;)

# Here is the output data frame
head(out.2.2)</code></pre>
<pre><code>##       time        y0           y1         y2 Sum
## [1,] 0e+00 1.0000000 0.000000e+00 0.00000000   1
## [2,] 4e-01 0.9851723 3.386399e-05 0.01479384   1
## [3,] 4e+00 0.9055179 2.240437e-05 0.09445974   1
## [4,] 4e+01 0.7158298 9.185501e-06 0.28416101   1
## [5,] 4e+02 0.4505174 3.222887e-06 0.54947938   1
## [6,] 4e+03 0.1831994 8.942298e-07 0.81679972   1</code></pre>
<pre class="r"><code># Plotting
plot(out.2.2, log=&quot;x&quot;, type=&quot;b&quot;)</code></pre>
<pre><code>## Warning in xy.coords(x, y, xlabel, ylabel, log): 1 x value &lt;= 0 omitted from
## logarithmic plot

## Warning in xy.coords(x, y, xlabel, ylabel, log): 1 x value &lt;= 0 omitted from
## logarithmic plot

## Warning in xy.coords(x, y, xlabel, ylabel, log): 1 x value &lt;= 0 omitted from
## logarithmic plot

## Warning in xy.coords(x, y, xlabel, ylabel, log): 1 x value &lt;= 0 omitted from
## logarithmic plot</code></pre>
<p><img src="/post/2018-03-09-mcsim-under-r/index_files/figure-html/unnamed-chunk-19-1.png" width="672" /></p>
</div>
</div>
</div>
<div id="gnu-mcsim-solution" class="section level1">
<h1><strong>GNU MCSim</strong> solution</h1>
<p>Here we want to use GNU MCSim to solve ODE. In this part, we need to have the input file (<code>simple.in</code>) in the working directory. The input file can define the initial and parameter values, respectively. Also,we need to set the output time steps and intervals. The source code looks like this:</p>
<pre><code>###############
## simple.in ##
###############

Simulation {

  # Initial value
  y0 = 1;

  # Parameters
  k1 = 0.04;
  k2 = 1e4;
  k3 = 3e7;

  Print (y0, y1, y2, yout, 4e-1, 4e+0, 4e+1, 4e+2, 4e+3, 4e+4, 4e+5, 4e+6, 4e+7, 4e+8, 
         4e+9);
}

End.</code></pre>
<p>The following step compile the <code>simple.model</code> file and create the executable program named <code>mcsim.simple.model.exe</code>.</p>
<pre class="r"><code>mcsim &lt;- &quot;MinGM-6.1.0&quot;
model &lt;- &quot;simple.model&quot;
input &lt;- &quot;simple.in&quot;
system(paste0(mcsim, &quot;/mod.exe &quot;, model, &quot; &quot;, model, &quot;.c&quot;)) </code></pre>
<p>Unlike above exercice, we need to remove the -R flag that can only create c file. Then, compile the <code>simple.model.c</code> to <code>mcsim.simple.model.exe</code>.</p>
<pre class="r"><code>system(paste0(&quot;gcc -O3 -I.. -I &quot;, mcsim,&quot;/sim -o mcsim.&quot;, model, &quot;.exe &quot;, 
       model, &quot;.c &quot;, mcsim, &quot;/sim/*.c -lm &quot;))</code></pre>
<pre class="r"><code># run!
system(paste0(&quot;./mcsim.&quot;, model, &quot;.exe &quot;, input))</code></pre>
<pre class="r"><code># the output file is called out by default, load it
out.3 &lt;- read.delim(&quot;sim.out&quot;, skip = 2)
head (out.3)</code></pre>
<pre><code>##    Time        y0          y1        y2 yout
## 1 4e-01 0.9851720 3.38640e-05 0.0147937    1
## 2 4e+00 0.9055160 2.24043e-05 0.0944616    1
## 3 4e+01 0.7158290 9.18560e-06 0.2841620    1
## 4 4e+02 0.4505040 3.22272e-06 0.5494920    1
## 5 4e+03 0.1831970 8.94202e-07 0.8168020    1
## 6 4e+04 0.0389846 1.62182e-07 0.9610150    1</code></pre>
<pre class="r"><code># look
par(mfrow=c(2,2))
plot(out.3[,1], out.3[,2], log=&quot;x&quot;,type=&quot;b&quot;, xlab = &quot;time&quot;, ylab = &quot;&quot;, main = &quot;y0&quot;)
plot(out.3[,1], out.3[,3], log=&quot;x&quot;,type=&quot;b&quot;, xlab = &quot;time&quot;, ylab = &quot;&quot;, main = &quot;y1&quot;)
plot(out.3[,1], out.3[,4], log=&quot;x&quot;,type=&quot;b&quot;, xlab = &quot;time&quot;, ylab = &quot;&quot;, main = &quot;y2&quot;)
plot(out.3[,1], out.3[,5], log=&quot;x&quot;,type=&quot;b&quot;, xlab = &quot;time&quot;, ylab = &quot;&quot;, main = &quot;yout&quot;)</code></pre>
<p><img src="/post/2018-03-09-mcsim-under-r/index_files/figure-html/unnamed-chunk-23-1.png" width="672" /></p>
<p>In addition, creating the R function can help us conduct the simulation more easily,</p>
<pre class="r"><code># Create function
mingm &lt;- function(mcsim, model, input){
  system(paste0(mcsim, &quot;/mod.exe &quot;, model, &quot; &quot;, model, &quot;.c&quot;)) 
  paste0(&quot;gcc -O3 -I.. -I &quot;, mcsim,&quot;/sim -o mcsim.&quot;, model, &quot;.exe &quot;,
         model, &quot;.c &quot;, mcsim, &quot;/sim/*.c -lm &quot;)
  system(paste0(&quot;./mcsim.&quot;, model, &quot;.exe &quot;, input))
}</code></pre>
<pre class="r"><code>mingm(mcsim = &quot;MinGM-6.1.0&quot;, model = &quot;simple.model&quot;, input = &quot;simple.in&quot;)</code></pre>
<pre class="r"><code>out.4 &lt;- read.delim(&quot;sim.out&quot;, skip = 2)
head (out.4)</code></pre>
<pre><code>##    Time        y0          y1        y2 yout
## 1 4e-01 0.9851720 3.38640e-05 0.0147937    1
## 2 4e+00 0.9055160 2.24043e-05 0.0944616    1
## 3 4e+01 0.7158290 9.18560e-06 0.2841620    1
## 4 4e+02 0.4505040 3.22272e-06 0.5494920    1
## 5 4e+03 0.1831970 8.94202e-07 0.8168020    1
## 6 4e+04 0.0389846 1.62182e-07 0.9610150    1</code></pre>
</div>
<div id="session-info" class="section level1">
<h1>Session info</h1>
<pre class="r"><code>sessionInfo()</code></pre>
<pre><code>## R version 3.6.2 (2019-12-12)
## Platform: x86_64-w64-mingw32/x64 (64-bit)
## Running under: Windows 10 x64 (build 17763)
## 
## Matrix products: default
## 
## locale:
## [1] LC_COLLATE=English_United States.1252 
## [2] LC_CTYPE=English_United States.1252   
## [3] LC_MONETARY=English_United States.1252
## [4] LC_NUMERIC=C                          
## [5] LC_TIME=English_United States.1252    
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
## [1] deSolve_1.25
## 
## loaded via a namespace (and not attached):
##  [1] Rcpp_1.0.3        compiler_3.6.2    prettyunits_1.0.2 remotes_2.1.0    
##  [5] tools_3.6.2       testthat_2.3.1    digest_0.6.23     pkgbuild_1.0.6   
##  [9] pkgload_1.0.2     evaluate_0.14     memoise_1.1.0     rlang_0.4.2      
## [13] cli_2.0.0         rstudioapi_0.10   yaml_2.2.0        blogdown_0.17    
## [17] xfun_0.11         withr_2.1.2       stringr_1.4.0     knitr_1.26       
## [21] fs_1.3.1          desc_1.2.0        devtools_2.2.1    rprojroot_1.3-2  
## [25] glue_1.3.1        R6_2.4.1          processx_3.4.1    fansi_0.4.0      
## [29] rmarkdown_2.0     bookdown_0.16     sessioninfo_1.1.1 callr_3.4.0      
## [33] magrittr_1.5      backports_1.1.5   ps_1.3.0          ellipsis_0.3.0   
## [37] htmltools_0.4.0   usethis_1.5.1     assertthat_0.2.1  stringi_1.4.3    
## [41] crayon_1.3.4</code></pre>
</div>
