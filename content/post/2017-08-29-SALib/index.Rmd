---
title: 'Sensitivity Analysis by Python SALib'
summary: Using Python SALib to conduct global sensitivity analysis (under R interface)
authors:
- admin
date: "2017-08-29"
output:
  blogdown::html_page:
    toc: true
    toc_depth: 2
projects: [FDA-PBPK]
categories: [sensitivity]
tags: [sensitivity, Sobol, python]

# Featured image
# To use, add an image named `featured.jpg/png` to your page's folder.
# Placement options: 1 = Full column width, 2 = Out-set, 3 = Screen-width
# Focal point options: Smart, Center, TopLeft, Top, TopRight, Left, Right, BottomLeft, Bottom, BottomRight  
# image:
#  placement: 2
#  preview_only: true
#  focal_point: 'TopRight'
#  caption: 'Image credit: [**Unsplash**](https://unsplash.com/photos/CpkOjOcXdUY)'

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(eval = T)
```

{{% alert note %}}
<strong>**The post was updated on `r Sys.Date()` under `r sessioninfo::os_name()`.**</strong>
{{% /alert %}}

> Sensitivity Analysis is the study of how uncertainty in the output of a model (numerical or otherwise) can be apportioned to different sources of uncertainty in the model input. - [Global Sensitivity Analysis: The Primer](https://www.wiley.com/en-us/Global+Sensitivity+Analysis%3A+The+Primer-p-9780470059975)

According to the above definition, sensitivity analysis is a mathematical method to understand how model output influenced by the uncertainty in the model parameters. In this post, I used a simple [example](https://salib.readthedocs.io/en/latest/basics.html) to perform a sensitivity analysis by python module [**SALib**](https://salib.readthedocs.io/en/latest/index.html). In addition, the [Sobol](https://salib.readthedocs.io/en/latest/api.html#sobol-sensitivity-analysis) method was used as an example and visualized the test results in R. The running environment was in R and utilized [**reticulate**](https://rstudio.github.io/reticulate/) package to call Python from R. 

## Installation & setting

The following command is used to install the related R package (**reticulate** & **ggplot**) and python **SALib**.

```{r, eval=F}
install.packages("reticulate")
install.packages("ggplot2")
```

```{r}
library(reticulate)
```

```{r, eval=F}
py_install("SALib")
```

Instead, using `pip3 install SALib` in the terminal can also install **SALib**.

```{r}
# Load ggplot for plotting
library(ggplot2)
```

The reticulate uses the version of Python found in PATH by default. The `use_python()` and `Sys.which()` functions can help us assign the alternate version and check it, for example:

```{r}
use_python("/usr/bin/python3")
Sys.which("python3")
```

## Sensitivity analysis by SALib

There are two ways to call python script. One uses ` source_python()` to read the python script. The other is to use Python REPL embedded within the R session by `repl_python()`. After the analysis in Python REPL, use `exit` to return to the R prompt. The following is the python script that conducts Sobol sensitivity analysis for Ishigami function (sourced from **SALib** example).
The [Ishigami function](https://www.sfu.ca/~ssurjano/ishigami.html) is a classic function that can be used to test uncertainty and conduct sensitivity analysis. The parameters in the Ishigami function also have strong nonlinearity or nonmonotonicity with outputs.

$$f(x)=sin(x_1)+asin^2(x_2)+bx_{3}^4(x_1)$$

According to the [sorce code](https://github.com/SALib/SALib/blob/master/src/SALib/test_functions/Ishigami.py) in SALib, the default setting of $a$ and $b$ are 7 and 0.1. In addition, the distribution of $X_1$, $X_2$, and $X_3$ are uniform distributions ranged between $-\pi$ and $\pi$.

```{python}
# Importing SALib
import SALib
import random
from SALib.sample import saltelli
from SALib.analyze import sobol
from SALib.test_functions import Ishigami

# Set random seed to reproduce the same result
random.seed( 10 )

# Define the model inputs
problem = {
  'num_vars': 3,
  'names': ['x1', 'x2', 'x3'],
  'bounds': [[-3.14159265359, 3.14159265359],
             [-3.14159265359, 3.14159265359],
             [-3.14159265359, 3.14159265359]]
}
# Generate samples
X = saltelli.sample(problem, 1000)

# Run model (example)
Y = Ishigami.evaluate(X)

# Perform analysis
Si = sobol.analyze(problem, Y, print_to_console=True)
```

By using Sobol sensitivity analysis, we can obtain three sensitivity indices, which are first-order index (`S1`; the contribution to the output variance by a single model parameter alone), second-order index (`S2`; the contribution to the output variance caused by the interaction of two model parameters), and total-order index  (`ST`; the contribution to the output variance caused by a model parameters, including both its first-order effects and interactions). The confidence interval is generated by resampling that can be used to check the convergence of the estimated results.

## Visualization in R

Back to R, the following step is to do the necessary data manipulation and visualize the result. The results of the analysis are stored in the object `py`.

```{r}
py$Si
```

The Saltelli sampler generated $N\times(2D+2)$ samples (8000 samples in this case) to evaluate the model sensitivity, where $N$ is the setting sample number(1000 in this case), and $D$ is the number of model inputs (3 in this case).

```{r fig.height=3}
par(mfrow=c(1,3), mar=c(2,2,2,1))
plot(py$X[,1], main="X1")
plot(py$X[,2], main="X2")
plot(py$X[,3], main="X3")
```

The below scatter plot of parameters ($X$) and model output ($Y$) can be used to understand the parameter effect on the output variance.

```{r fig.height=3}
par(mfrow=c(1,3), mar=c(2,2,2,1))
plot(py$X[,1], py$Y, pch = ".", main="X1")
plot(py$X[,2], py$Y, pch = ".", main="X2")
plot(py$X[,3], py$Y, pch = ".", main="X3")
```

Finally, we can use the calculated sensitivity index to investigate the influence of model parameters.

```{r}
# Create the data frame for ggplot
parms <- c("x1", "x2", "x3")
sobol <- c(py$Si$S1, py$Si$ST)
conf <- c(py$Si$S1_conf, py$Si$ST_conf)
df <- data.frame(parms, sobol, conf)
df$Order <- rep(c("Main", "Total"), each = 3)
df
```

```{r}
# Plotting
pd <- position_dodge(0.1)
theme_set(theme_bw())
ggplot(df, aes(x=parms, y=sobol, group=Order, color=Order)) + 
  geom_errorbar(aes(ymin=sobol-conf, ymax=sobol+conf), width=0, position=pd) +
  geom_point(position=pd, size=3) +
  labs(x="Parameter", y="Sobol index")
```

According to this result, we can easily find that the parameter $X1$ has the highest effect on model output based on the total effect. In addition, the current result also shows that the estimated Sobol index does not reach the acceptable convergence (wider confidence interval). Therefore, the sample number needs to increase further to improve the variation in the estimation.

## Session info

```{r}
sessionInfo()
```

```{r}
py_discover_config()
```
