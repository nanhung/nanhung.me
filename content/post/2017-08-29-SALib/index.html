---
title: 'Sensitivity Analysis by Python SALib'
summary: Using Python SALib to conduct global sensitivity analysis (under R interface)
authors:
- admin
date: "2017-08-29"
output:
  blogdown::html_page:
    toc: true
    toc_depth: 2
projects: [FDA-PBPK]
categories: [sensitivity]
tags: [sensitivity, Sobol, python]

# Featured image
# To use, add an image named `featured.jpg/png` to your page's folder.
# Placement options: 1 = Full column width, 2 = Out-set, 3 = Screen-width
# Focal point options: Smart, Center, TopLeft, Top, TopRight, Left, Right, BottomLeft, Bottom, BottomRight  
# image:
#  placement: 2
#  preview_only: true
#  focal_point: 'TopRight'
#  caption: 'Image credit: [**Unsplash**](https://unsplash.com/photos/CpkOjOcXdUY)'

---


<div id="TOC">
<ul>
<li><a href="#installation-setting">Installation &amp; setting</a></li>
<li><a href="#sensitivity-analysis-by-salib">Sensitivity analysis by SALib</a></li>
<li><a href="#visualization-in-r">Visualization in R</a></li>
</ul>
</div>

<p>{{% alert note %}}
<strong><strong>The post was updated on 2019-12-25 under Ubuntu 19.10.</strong></strong>
{{% /alert %}}</p>
<blockquote>
<p>Sensitivity Analysis is the study of how uncertainty in the output of a model (numerical or otherwise) can be apportioned to different sources of uncertainty in the model input. - <a href="https://www.wiley.com/en-us/Global+Sensitivity+Analysis%3A+The+Primer-p-9780470059975">Global Sensitivity Analysis: The Primer</a></p>
</blockquote>
<p>According to the above definition, sensitivity analysis is a mathematical method to understand how model output influenced by the uncertainty in the model parameters. In this post, I used a simple <a href="https://salib.readthedocs.io/en/latest/basics.html">example</a> to perform a sensitivity analysis by python module <a href="https://salib.readthedocs.io/en/latest/index.html"><strong>SALib</strong></a>. In addition, the <a href="https://salib.readthedocs.io/en/latest/api.html#sobol-sensitivity-analysis">Sobol</a> method was used as an example and visualized the test results in R. The running environment was in R and utilized <a href="https://rstudio.github.io/reticulate/"><strong>reticulate</strong></a> package to call Python from R.</p>
<div id="installation-setting" class="section level2">
<h2>Installation &amp; setting</h2>
<p>The following command is used to install the related R package (<strong>reticulate</strong> &amp; <strong>ggplot</strong>) and python <strong>SALib</strong>.</p>
<pre class="r"><code>install.packages(&quot;reticulate&quot;)
install.packages(&quot;ggplot2&quot;)
py_install(&quot;SALib&quot;)</code></pre>
<p>Instead, using <code>pip3 install SALib</code> in the terminal can also install <strong>SALib</strong>.</p>
<pre class="r"><code># Load packages
library(reticulate)
library(ggplot2)</code></pre>
<p>The reticulate uses the version of Python found in PATH by default. The <code>use_python()</code> and <code>Sys.which()</code> functions can help us assign the alternate version and check it, for example:</p>
<pre class="r"><code>use_python(&quot;/home/nanhung/.local/share/r-miniconda/envs/r-reticulate/bin/python3&quot;)
Sys.which(&quot;python3&quot;)</code></pre>
<pre><code>##            python3 
## &quot;/usr/bin/python3&quot;</code></pre>
</div>
<div id="sensitivity-analysis-by-salib" class="section level2">
<h2>Sensitivity analysis by SALib</h2>
<p>There are two ways to call python script. One uses <code>source_python()</code> to read the python script. The other is to use Python REPL embedded within the R session by <code>repl_python()</code>. After the analysis in Python REPL, use <code>exit</code> to return to the R prompt. The following is the python script that conducts Sobol sensitivity analysis for Ishigami function (sourced from <strong>SALib</strong> example).
The <a href="https://www.sfu.ca/~ssurjano/ishigami.html">Ishigami function</a> is a classic function that can be used to test uncertainty and conduct sensitivity analysis. The parameters in the Ishigami function also have strong nonlinearity or nonmonotonicity with outputs.</p>
<p><span class="math display">\[f(x)=sin(x_1)+asin^2(x_2)+bx_{3}^4(x_1)\]</span></p>
<p>According to the <a href="https://github.com/SALib/SALib/blob/master/src/SALib/test_functions/Ishigami.py">sorce code</a> in SALib, the default setting of <span class="math inline">\(a\)</span> and <span class="math inline">\(b\)</span> are 7 and 0.1. In addition, the distribution of <span class="math inline">\(X_1\)</span>, <span class="math inline">\(X_2\)</span>, and <span class="math inline">\(X_3\)</span> are uniform distributions ranged between <span class="math inline">\(-\pi\)</span> and <span class="math inline">\(\pi\)</span>.</p>
<pre class="python"><code># Importing SALib
import SALib
import random
from SALib.sample import saltelli
from SALib.analyze import sobol
from SALib.test_functions import Ishigami

# Set random seed to reproduce the same result
random.seed( 10 )

# Define the model inputs
problem = {
  &#39;num_vars&#39;: 3,
  &#39;names&#39;: [&#39;x1&#39;, &#39;x2&#39;, &#39;x3&#39;],
  &#39;bounds&#39;: [[-3.14159265359, 3.14159265359],
             [-3.14159265359, 3.14159265359],
             [-3.14159265359, 3.14159265359]]
}
# Generate samples
X = saltelli.sample(problem, 1000)

# Run model (example)
Y = Ishigami.evaluate(X)

# Perform analysis
Si = sobol.analyze(problem, Y, print_to_console=True)</code></pre>
<pre><code>## Parameter S1 S1_conf ST ST_conf
## x1 0.307975 0.055089 0.560137 0.088925
## x2 0.447767 0.049588 0.438722 0.038559
## x3 -0.004255 0.065758 0.242845 0.027701
## 
## Parameter_1 Parameter_2 S2 S2_conf
## x1 x2 0.012205 0.084895
## x1 x3 0.251526 0.111228
## x2 x3 -0.009954 0.063370</code></pre>
<p>By using Sobol sensitivity analysis, we can obtain three sensitivity indices, which are first-order index (<code>S1</code>; the contribution to the output variance by a single model parameter alone), second-order index (<code>S2</code>; the contribution to the output variance caused by the interaction of two model parameters), and total-order index (<code>ST</code>; the contribution to the output variance caused by a model parameters, including both its first-order effects and interactions). The confidence interval is generated by resampling that can be used to check the convergence of the estimated results.</p>
</div>
<div id="visualization-in-r" class="section level2">
<h2>Visualization in R</h2>
<p>Back to R, the following step is to do the necessary data manipulation and visualize the result. The results of the analysis are stored in the object <code>py</code>.</p>
<pre class="r"><code>py$Si</code></pre>
<pre><code>## $S1
## [1]  0.307975489  0.447766610 -0.004254525
## 
## $S1_conf
## [1] 0.05508937 0.04958850 0.06575803
## 
## $ST
## [1] 0.5601373 0.4387225 0.2428447
## 
## $ST_conf
## [1] 0.08892543 0.03855904 0.02770097
## 
## $S2
##      [,1]       [,2]        [,3]
## [1,]  NaN 0.01220462  0.25152574
## [2,]  NaN        NaN -0.00995392
## [3,]  NaN        NaN         NaN
## 
## $S2_conf
##      [,1]       [,2]      [,3]
## [1,]  NaN 0.08489464 0.1112277
## [2,]  NaN        NaN 0.0633695
## [3,]  NaN        NaN       NaN</code></pre>
<p>The Saltelli sampler generated <span class="math inline">\(N\times(2D+2)\)</span> samples (8000 samples in this case) to evaluate the model sensitivity, where <span class="math inline">\(N\)</span> is the setting sample number(1000 in this case), and <span class="math inline">\(D\)</span> is the number of model inputs (3 in this case).</p>
<pre class="r"><code>par(mfrow=c(1,3), mar=c(2,2,2,1))
plot(py$X[,1], main=&quot;X1&quot;)
plot(py$X[,2], main=&quot;X2&quot;)
plot(py$X[,3], main=&quot;X3&quot;)</code></pre>
<p><img src="/post/2017-08-29-SALib/index_files/figure-html/unnamed-chunk-6-1.png" width="672" /></p>
<p>The below scatter plot of parameters (<span class="math inline">\(X\)</span>) and model output (<span class="math inline">\(Y\)</span>) can be used to understand the parameter effect on the output variance.</p>
<pre class="r"><code>par(mfrow=c(1,3), mar=c(2,2,2,1))
plot(py$X[,1], py$Y, pch = &quot;.&quot;, main=&quot;X1&quot;)
plot(py$X[,2], py$Y, pch = &quot;.&quot;, main=&quot;X2&quot;)
plot(py$X[,3], py$Y, pch = &quot;.&quot;, main=&quot;X3&quot;)</code></pre>
<p><img src="/post/2017-08-29-SALib/index_files/figure-html/unnamed-chunk-7-1.png" width="672" /></p>
<p>Finally, we can use the calculated sensitivity index to investigate the influence of model parameters.</p>
<pre class="r"><code># Create the data frame for ggplot
parms &lt;- c(&quot;x1&quot;, &quot;x2&quot;, &quot;x3&quot;)
sobol &lt;- c(py$Si$S1, py$Si$ST)
conf &lt;- c(py$Si$S1_conf, py$Si$ST_conf)
df &lt;- data.frame(parms, sobol, conf)
df$Order &lt;- rep(c(&quot;Main&quot;, &quot;Total&quot;), each = 3)
df</code></pre>
<pre><code>##   parms        sobol       conf Order
## 1    x1  0.307975489 0.05508937  Main
## 2    x2  0.447766610 0.04958850  Main
## 3    x3 -0.004254525 0.06575803  Main
## 4    x1  0.560137277 0.08892543 Total
## 5    x2  0.438722499 0.03855904 Total
## 6    x3  0.242844745 0.02770097 Total</code></pre>
<pre class="r"><code># Plotting
pd &lt;- position_dodge(0.1)
theme_set(theme_bw())
ggplot(df, aes(x=parms, y=sobol, group=Order, color=Order)) + 
  geom_errorbar(aes(ymin=sobol-conf, ymax=sobol+conf), width=0, position=pd) +
  geom_point(position=pd, size=3) +
  labs(x=&quot;Parameter&quot;, y=&quot;Sobol index&quot;)</code></pre>
<p><img src="/post/2017-08-29-SALib/index_files/figure-html/unnamed-chunk-9-1.png" width="672" /></p>
<p>According to this result, we can easily find that the parameter <span class="math inline">\(X1\)</span> has the highest effect on model output based on the total effect. In addition, the current result also shows that the estimated Sobol index does not reach the acceptable convergence (wider confidence interval). Therefore, the sample number needs to increase further to improve the variation in the estimation.
## Session info</p>
<pre class="r"><code>sessionInfo()</code></pre>
<pre><code>## R version 3.6.2 (2019-12-12)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Ubuntu 19.10
## 
## Matrix products: default
## BLAS:   /usr/lib/x86_64-linux-gnu/blas/libblas.so.3.8.0
## LAPACK: /usr/lib/x86_64-linux-gnu/lapack/liblapack.so.3.8.0
## 
## locale:
##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
##  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
##  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            
## [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## attached base packages:
## [1] stats     graphics  grDevices utils     datasets  methods   base     
## 
## other attached packages:
## [1] ggplot2_3.2.1   reticulate_1.14
## 
## loaded via a namespace (and not attached):
##  [1] Rcpp_1.0.3        compiler_3.6.2    pillar_1.4.3      tools_3.6.2      
##  [5] digest_0.6.23     jsonlite_1.6      evaluate_0.14     lifecycle_0.1.0  
##  [9] tibble_2.1.3      gtable_0.3.0      pkgconfig_2.0.3   rlang_0.4.2      
## [13] cli_2.0.0         rstudioapi_0.10   yaml_2.2.0        blogdown_0.17    
## [17] xfun_0.11         dplyr_0.8.3       withr_2.1.2       stringr_1.4.0    
## [21] knitr_1.26        rappdirs_0.3.1    tidyselect_0.2.5  grid_3.6.2       
## [25] glue_1.3.1        R6_2.4.1          fansi_0.4.0       rmarkdown_2.0    
## [29] bookdown_0.16     sessioninfo_1.1.1 farver_2.0.1      purrr_0.3.3      
## [33] magrittr_1.5      scales_1.1.0      htmltools_0.4.0   assertthat_0.2.1 
## [37] colorspace_1.4-1  labeling_0.3      stringi_1.4.3     lazyeval_0.2.2   
## [41] munsell_0.5.0     crayon_1.3.4</code></pre>
<pre class="r"><code>py_discover_config()</code></pre>
<pre><code>## python:         /home/nanhung/.local/share/r-miniconda/envs/r-reticulate/bin/python
## libpython:      /home/nanhung/.local/share/r-miniconda/envs/r-reticulate/lib/libpython3.6m.so
## pythonhome:     /home/nanhung/.local/share/r-miniconda/envs/r-reticulate:/home/nanhung/.local/share/r-miniconda/envs/r-reticulate
## version:        3.6.9 |Anaconda, Inc.| (default, Jul 30 2019, 19:07:31)  [GCC 7.3.0]
## numpy:          /home/nanhung/.local/share/r-miniconda/envs/r-reticulate/lib/python3.6/site-packages/numpy
## numpy_version:  1.17.4</code></pre>
</div>
