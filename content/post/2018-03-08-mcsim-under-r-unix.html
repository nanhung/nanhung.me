---
title: MCSim under R (Unix)
summary: The exercise of use GNU MCsim under R in Unix system 
author: Nan-Hung Hsieh
date: '2018-03-08'
slug: mcsim-under-r-unix
categories: []
tags:
  - mcsim
  - R
  - unix
output:
  blogdown::html_page:
    toc: true
    number_sections: true
    toc_depth: 1
---


<div id="TOC">
<ul>
<li><a href="#solve-ode-in-pure-r"><span class="toc-section-number">1</span> Solve ODE in pure R</a></li>
<li><a href="#compile-the-mcsim-model-file-and-solve-by-desolve"><span class="toc-section-number">2</span> Compile the MCSim model file and solve by deSolve</a></li>
<li><a href="#compile-the-mcsim-model-file-and-solve-by-mcsim"><span class="toc-section-number">3</span> Compile the MCSim model file and solve by MCSim</a></li>
</ul>
</div>

<div id="prerequisites" class="section level2">
<h2><span class="header-section-number">0.1</span> Prerequisites</h2>
<ul>
<li>R</li>
<li>R Studio (optional)</li>
<li>MCSim</li>
</ul>
<p>This exercise was sourced from the file <a href="https://www.gnu.org/software/mcsim/mcsim_under_R.zip"><strong>MCSim under R</strong></a> in <a href="https://www.gnu.org/software/mcsim/"><strong>GNU MCSim</strong></a>. The testing operation system is <a href="https://lubuntu.net/"><strong>Lubuntu v17.10</strong></a> with MCSim v5.6.6 and R v3.4.0 installed. <span class="math inline">\(\mu\)</span></p>
<p>{{% alert warning %}} Be sure you’re in the right place. Check <code>.Platform$OS.type == &quot;unix&quot;</code> first! Windows user can read <a href="https://nanhung.rbind.io/post/mcsim-under-r-windows/"><strong>this instruction</strong></a>. {{% /alert %}}</p>
<p>Also, we can use this method,</p>
<pre><code>cat(system(&quot;lsb_release -a&quot;, intern = T), sep = &#39;\n&#39;)</code></pre>
<hr />
</div>
<div id="solve-ode-in-pure-r" class="section level1">
<h1><span class="header-section-number">1</span> Solve ODE in pure R</h1>
<pre class="r"><code>library(deSolve)

model &lt;- function(t, Y, parameters) {
  with (as.list(parameters), {
    dy1 = -k1*Y[1] + k2*Y[2]*Y[3];
    dy3 = k3*Y[2]*Y[2];
    dy2 = -dy1 - dy3;
    list(c(dy1, dy2, dy3));
    })
}

jac &lt;- function (t, Y, parameters) {
  with (as.list(parameters), {
       PD[1,1] &lt;- -k1;
       PD[1,2] &lt;- k2*Y[3];
       PD[1,3] &lt;- k2*Y[2];
       PD[2,1] &lt;- k1;
       PD[2,3] &lt;- -PD[1,3];
       PD[3,2] &lt;- k3*Y[2];
       PD[2,2] &lt;- -PD[1,2] - PD[3,2];

       return(PD) 
    }) 
}


parms &lt;- c(k1 = 0.04, k2 = 1e4, k3=3e7) 

Y &lt;- c(y1 = 1.0, y2 = 0.0, y3 = 0.0)

times  &lt;- c(0, 0.4*10^(0:11))

PD &lt;- matrix(nrow = 3, ncol = 3, data = 0)

out.1 &lt;- ode(Y, times, model, parms = parms, jacfunc = jac)

plot(out.1,type=&quot;b&quot;,log=&quot;x&quot;)</code></pre>
<p><img src="/post/2018-03-08-mcsim-under-r-unix_files/figure-html/unnamed-chunk-1-1.png" width="672" /></p>
</div>
<div id="compile-the-mcsim-model-file-and-solve-by-desolve" class="section level1">
<h1><span class="header-section-number">2</span> Compile the MCSim model file and solve by deSolve</h1>
<div id="prepare-model-file" class="section level2">
<h2><span class="header-section-number">2.1</span> Prepare model file</h2>
<p>The testing model <code>simple.model</code> file looks like this:</p>
<pre><code>#------------------------------------------------------------------------------
# the deSolve example model (simple.model)
#------------------------------------------------------------------------------

States = {y0, y1, y2};

Outputs = {yout};

# Parameters
k1 = 1;
k2 = 1;
k3 = 1;

Dynamics {

  dt(y0) = -k1 * y0 + k2 * y1 * y2; 
  dt(y2) =  k3 * y1 * y1; 
  dt(y1) = -dt(y0) - dt(y2);

  yout = y0 + y1 + y2;

} # End of Dynamics

Events {
  y0 = 1;
}

Roots { # here we need inlining, otherwise &#39;gout&#39; will not be understood 
  Inline ( gout[0] = y[0] - 0.5; );
}

End.</code></pre>
<p>The following step can compile the <code>simple.model</code> file and create the executable program</p>
<p>{{% alert warning %}} Make sure that the <code>simple.model</code> is put in the working directory! {{% /alert %}}</p>
<pre class="r"><code>mName &lt;- &quot;simple.model&quot;

# Create .c file and use -R to generate &quot;simple.model_inits.R&quot; initialization file
system (paste(&quot;mod -R &quot;, mName, &quot; &quot;, mName, &quot;.c&quot;, sep = &quot;&quot;)) 
system (paste(&quot;R CMD SHLIB &quot;, mName, &quot;.c&quot;, sep = &quot;&quot;)) # create .o and .so files
dyn.load(paste(mName, .Platform$dynlib.ext, sep=&quot;&quot;))
source (&quot;simple.model_inits.R&quot;)

parms_init &lt;- initParms () # define parameter values
Y_init &lt;- initStates (parms) # define initial state values

# Check the default parameters, initial values
parms; Y</code></pre>
<pre><code>##    k1    k2    k3 
## 4e-02 1e+04 3e+07</code></pre>
<pre><code>## y1 y2 y3 
##  1  0  0</code></pre>
<pre class="r"><code># list output variable, not a nice name will will call it &quot;Sum&quot; below
Outputs </code></pre>
<pre><code>## [1] &quot;yout&quot;</code></pre>
<pre class="r"><code># set output times, time 0 must be given
times &lt;- c(0, 0.4*10^(0:11)) # This setting is same as section 1

out.2.1 &lt;- ode(Y_init, times, func = &quot;derivs&quot;, parms = parms_init, 
               jacfunc = &quot;jac&quot;, dllname = &quot;simple.model&quot;, 
               initfunc = &quot;initmod&quot;, nout = 1, outnames = &quot;Sum&quot;)

plot(out.2.1, log=&quot;x&quot;,type=&quot;b&quot;)</code></pre>
<p><img src="/post/2018-03-08-mcsim-under-r-unix_files/figure-html/unnamed-chunk-2-1.png" width="672" /></p>
<p>{{% alert note %}} We can’t find any change in the dynamic process. It is due to the all initial value equal to 0.<br />
{{% /alert %}}</p>
</div>
<div id="customize-the-parameter-and-initial-values" class="section level2">
<h2><span class="header-section-number">2.2</span> Customize the parameter and initial values</h2>
<pre class="r"><code># Use the samee parameters and initial values in section 1
out.2.2 &lt;- ode(Y, times, func = &quot;derivs&quot;, parms = parms,
               dllname = mName, initfunc = &quot;initmod&quot;,
               nout = 1, outnames = &quot;Sum&quot;)

# Here is the output data frame
head(out.2.2)</code></pre>
<pre><code>##       time        y1           y2         y3 Sum
## [1,] 0e+00 1.0000000 0.000000e+00 0.00000000   1
## [2,] 4e-01 0.9851723 3.386399e-05 0.01479384   1
## [3,] 4e+00 0.9055179 2.240437e-05 0.09445974   1
## [4,] 4e+01 0.7158298 9.185501e-06 0.28416101   1
## [5,] 4e+02 0.4505174 3.222887e-06 0.54947938   1
## [6,] 4e+03 0.1831994 8.942298e-07 0.81679972   1</code></pre>
<pre class="r"><code># Plotting
plot(out.2.2, log=&quot;x&quot;,type=&quot;b&quot;)</code></pre>
<p><img src="/post/2018-03-08-mcsim-under-r-unix_files/figure-html/unnamed-chunk-3-1.png" width="672" /></p>
<pre class="r"><code># Use &quot;which&quot; to select specific variables
plot(out.2.2, log=&quot;x&quot;,type=&quot;b&quot;, which = c(&quot;y1&quot;, &quot;y2&quot;, &quot;y3&quot;))</code></pre>
<p><img src="/post/2018-03-08-mcsim-under-r-unix_files/figure-html/unnamed-chunk-3-2.png" width="672" /></p>
</div>
</div>
<div id="compile-the-mcsim-model-file-and-solve-by-mcsim" class="section level1">
<h1><span class="header-section-number">3</span> Compile the MCSim model file and solve by MCSim</h1>
<div id="prepare-in-file" class="section level2">
<h2><span class="header-section-number">3.1</span> Prepare in file</h2>
<p>In this part, we need to put <code>simple.in</code> file in the working directory. The in file define the initial and parameter values, respectively. Also,we need to set the output time steps and intervals. The source code looks like this:</p>
<pre><code>#------------------------------------------------------------------------------
# the deSolve example model run with GNU MCSim (simple.in)
#------------------------------------------------------------------------------

Integrate (Lsodes, 1E-7, 1E-7, 1);

Simulation {

  y0 = 1;

  # Parameters
  k1 = 0.04;
  k2 = 1e4;
  k3 = 3e7;

  Print (y0, 0, 4e-1, 4e+0, 4e+1, 4e+2, 4e+3, 4e+4, 4e+5, 4e+6, 4e+7, 4e+8, 
         4e+9, 4e+10);
  Print (y1, 0, 4e-1, 4e+0, 4e+1, 4e+2, 4e+3, 4e+4, 4e+5, 4e+6, 4e+7, 4e+8, 
         4e+9, 4e+10);
  Print (y2, 0, 4e-1, 4e+0, 4e+1, 4e+2, 4e+3, 4e+4, 4e+5, 4e+6, 4e+7, 4e+8, 
         4e+9, 4e+10);

  Print (yout, 0, 4e-1, 4e+0, 4e+1, 4e+2, 4e+3, 4e+4, 4e+5, 4e+6, 4e+7, 4e+8, 
         4e+9, 4e+10);

}

End.</code></pre>
<p>The following step compile the <code>simple.model</code> file and create the executable program named <code>mcsim.simple</code></p>
<pre class="r"><code>Name &lt;- &quot;simple&quot;
mName &lt;- &quot;simple.model&quot;

# compile the &quot;simple.model&quot; to &quot;mcsim.simple&quot;
system(paste(&quot;makemcsim &quot;, mName, sep = &quot;&quot;))

# run the simulation input file
# put its name here
inName &lt;- &quot;simple.in&quot;

# run!
system(paste(&quot;./mcsim.&quot;, Name, &quot; &quot;, inName, sep = &quot;&quot;))

# the output file is called out by default, load it
out.3 &lt;- read.delim(&quot;sim.out&quot;, skip = 2)

head (out.3)</code></pre>
<pre><code>##    Time       y0          y1        y2 yout
## 1 0e+00 1.000000 0.00000e+00 0.0000000    1
## 2 4e-01 0.985172 3.38640e-05 0.0147937    1
## 3 4e+00 0.905519 2.24048e-05 0.0944587    1
## 4 4e+01 0.715826 9.18549e-06 0.2841650    1
## 5 4e+02 0.450518 3.22290e-06 0.5494780    1
## 6 4e+03 0.183202 8.94234e-07 0.8167970    1</code></pre>
<pre class="r"><code># look

lo = layout(t(matrix(1:4, ncol = 2)), respect = TRUE)
plot(out.3[,1], out.3[,2], log=&quot;x&quot;,type=&quot;b&quot;, xlab = &quot;time&quot;, ylab = &quot;&quot;, main = &quot;y1&quot;)
plot(out.3[,1], out.3[,3], log=&quot;x&quot;,type=&quot;b&quot;, xlab = &quot;time&quot;, ylab = &quot;&quot;, main = &quot;y2&quot;)
plot(out.3[,1], out.3[,4], log=&quot;x&quot;,type=&quot;b&quot;, xlab = &quot;time&quot;, ylab = &quot;&quot;, main = &quot;y3&quot;)</code></pre>
<p><img src="/post/2018-03-08-mcsim-under-r-unix_files/figure-html/unnamed-chunk-4-1.png" width="672" /></p>
</div>
</div>
