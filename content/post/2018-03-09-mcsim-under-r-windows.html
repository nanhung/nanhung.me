---
title: MCSim under R (Windows)
summary: The exercise of use GNU MCsim under R in Windows system 
author: Nan-Hung Hsieh
date: '2018-03-09'
slug: mcsim-under-r-windows
categories: []
tags:
  - mcsim
  - R
  - windows
output:
  blogdown::html_page:
    toc: true
    number_sections: true
    toc_depth: 1  
---


<div id="TOC">
<ul>
<li><a href="#compile-the-mcsim-model-file-and-solve-by-desolve"><span class="toc-section-number">1</span> Compile the MCSim model file and solve by deSolve</a></li>
<li><a href="#compile-the-mcsim-model-file-and-solve-by-mcsim"><span class="toc-section-number">2</span> Compile the MCSim model file and solve by MCSim</a></li>
</ul>
</div>

<div id="prerequisites" class="section level2">
<h2><span class="header-section-number">0.1</span> Prerequisites</h2>
<ul>
<li>R</li>
<li>Rtools</li>
<li>R Studio (optional)</li>
<li>MCSim</li>
</ul>
<p>This exercise was sourced from the file <a href="https://www.gnu.org/software/mcsim/mcsim_under_R.zip"><strong>MCSim under R</strong></a> in <a href="https://www.gnu.org/software/mcsim/"><strong>GNU MCSim</strong></a>. The testing operation system is Windows 7 with MCSim v5.6.6 and R v3.4.0 installed.</p>
<p>{{% alert warning %}} Be sure you’re in the right place. Check <code>.Platform$OS.type == &quot;windows&quot;</code> first! Linux or MacOS user can read <a href="https://nanhung.rbind.io/post/mcsim-under-r-unix/"><strong>this instruction</strong></a>. {{% /alert %}}</p>
<p>If you have installed <code>devtools</code> you can use <code>devtools::find_rtools()</code> to check the avaliable of Rtools. Also, we need to chek the Rtools is in the PATH by using <code>Sys.getenv(&quot;PATH&quot;)</code>. If you can not find the Rtools in the your PATH such as</p>
<pre><code>[1] &quot;c:\\Rtools\\bin;c:\\Rtools\\mingw_32\\bin;c:\\Rtools\\gcc-4.6.3\\bin</code></pre>
<p>You will need to add the Rtools to your path manually, as follow</p>
<pre><code>Sys.setenv(PATH = paste(&quot;c:\\Rtools\\bin&quot;, Sys.getenv(&quot;PATH&quot;), sep=&quot;;&quot;))
Sys.setenv(PATH = paste(&quot;c:\\Rtools\\mingw_$(WIN)/bin&quot;, Sys.getenv(&quot;PATH&quot;), sep=&quot;;&quot;))
Sys.setenv(BINPREF = &quot;c:\\Rtools\\mingw_64/bin/&quot;)
</code></pre>
<p>Then, use following command to check the function.</p>
<pre class="r"><code>system(&#39;g++ -v&#39;)</code></pre>
<p>If you use git as version control, you can put following files to <code>.gitignore</code>.</p>
<pre><code>*.o
*.so
*.exe
*.dll</code></pre>
</div>
<div id="make-mod.exe" class="section level2">
<h2><span class="header-section-number">0.2</span> Make mod.exe</h2>
<p>The following step can compile the <code>simple.model</code> file and create the executable program. The testing model <code>simple.model</code> file looks like this:</p>
<pre><code>#------------------------------------------------------------------------------
# the deSolve example model (simple.model)
#------------------------------------------------------------------------------

States = {y0, y1, y2};

Outputs = {yout};

# Parameters
k1 = 1;
k2 = 1;
k3 = 1;

Dynamics {

  dt(y0) = -k1 * y0 + k2 * y1 * y2; 
  dt(y2) =  k3 * y1 * y1; 
  dt(y1) = -dt(y0) - dt(y2);

  yout = y0 + y1 + y2;

} # End of Dynamics

Events {
  y0 = 1;
}

Roots { # here we need inlining, otherwise &#39;gout&#39; will not be understood 
  Inline ( gout[0] = y[0] - 0.5; );
}

End.</code></pre>
<p>{{% alert warning %}} Make sure that the <code>simple.model</code> and <code>mod</code> folder is put in the working directory! {{% /alert %}}</p>
<p><strong>NOTE:</strong> In this case, we don't need to load libSBML. Therefore, check the <code>config.h</code> file in mod folder. We can see the line 26 in the <code>config.h file</code> like <a href="https://github.com/rbind/nanhung.me/blob/master/content/post/mod/config.h"><strong>THIS</strong></a>. 
The <code>#define HAVE_LIBSBML 1</code> had been disabled. It can prevent the problem when compile to the mod.exe file. (Thanks <strong>Yu-Sheng Lin</strong> for provding this issue; Mar. 23, 2018).</p>
<pre class="r"><code>libSBML = &quot;&quot; # libSBML = &quot;-lsbml&quot; 
# uncomment and execute if you have and want to use libSBML.

# create mod.exe in &quot;mod&quot; folder
system(paste(&quot;gcc -o ./mod/mod.exe ./mod/*.c &quot;, libSBML, sep = &quot;&quot;)) </code></pre>

<p>Use model file to check it works.</p>
<pre class="r"><code>mName &lt;- &quot;simple.model&quot;

# compile the model file to c file
system(paste(&quot;./mod/mod.exe -R &quot;, mName, &quot; &quot;, mName, &quot;.c&quot;, sep = &quot;&quot;)) </code></pre>
<p>If everything is going well, we can move on to next section.</p>
</div>
<div id="compile-the-mcsim-model-file-and-solve-by-desolve" class="section level1">
<h1><span class="header-section-number">1</span> Compile the MCSim model file and solve by deSolve</h1>
<div id="prepare-model-file" class="section level2">
<h2><span class="header-section-number">1.1</span> Prepare model file</h2>
<pre class="r"><code>library(deSolve)

# Create .c file and use -R to generate &quot;simple.model_inits.R&quot; initialization file
system(paste(&quot;./mod/mod.exe -R &quot;, mName, &quot; &quot;, mName, &quot;.c&quot;, sep = &quot;&quot;)) 
# compile the MCSim executable, needs to be done each time you modify the model

system (paste(&quot;R CMD SHLIB &quot;, mName, &quot;.c&quot;, sep = &quot;&quot;)) # create .o and .so files
dyn.load(paste(mName, .Platform$dynlib.ext, sep=&quot;&quot;)) # load simple.model.dll
source (&quot;simple.model_inits.R&quot;)

parms_init &lt;- initParms () # define parameter values
Y_init &lt;- initStates (parms) # define initial state values

# set output times, time 0 must be given
times &lt;- c(0, 0.4*10^(0:11))

out.2.1 &lt;- ode(Y_init, times, func = &quot;derivs&quot;, parms = parms_init, 
               jacfunc = &quot;jac&quot;, dllname = &quot;simple.model&quot;, 
               initfunc = &quot;initmod&quot;, nout = 1, outnames = &quot;Sum&quot;)

plot(out.2.1, log=&quot;x&quot;,type=&quot;b&quot;)</code></pre>
<p><img src="/post/2018-03-09-mcsim-under-r-windows_files/figure-html/unnamed-chunk-4-1.png" width="672" /></p>
<p>{{% alert note %}} We can’t find any change in the dynamic process. It is due to the all initial value equal to 0.<br />
{{% /alert %}}</p>
</div>
<div id="customize-the-parameter-and-initial-values" class="section level2">
<h2><span class="header-section-number">1.2</span> Customize the parameter and initial values</h2>
<pre class="r"><code># Define the parameters and initial values
parms &lt;- c(k1 = 0.04, k2 = 1e4, k3=3e7) 
Y &lt;- c(y1 = 1.0, y2 = 0.0, y3 = 0.0)

# Use the defined parameters and initial values
out.2.2 &lt;- ode(Y, times, func = &quot;derivs&quot;, parms = parms,
               dllname = mName, initfunc = &quot;initmod&quot;,
               nout = 1, outnames = &quot;Sum&quot;)

# Here is the output data frame
head(out.2.2)</code></pre>
<pre><code>##       time        y1           y2         y3 Sum
## [1,] 0e+00 1.0000000 0.000000e+00 0.00000000   1
## [2,] 4e-01 0.9851723 3.386399e-05 0.01479384   1
## [3,] 4e+00 0.9055179 2.240437e-05 0.09445974   1
## [4,] 4e+01 0.7158298 9.185501e-06 0.28416101   1
## [5,] 4e+02 0.4505174 3.222887e-06 0.54947938   1
## [6,] 4e+03 0.1831994 8.942298e-07 0.81679972   1</code></pre>
<pre class="r"><code># Plotting
plot(out.2.2, log=&quot;x&quot;,type=&quot;b&quot;)</code></pre>
<p><img src="/post/2018-03-09-mcsim-under-r-windows_files/figure-html/unnamed-chunk-5-1.png" width="672" /></p>
<pre class="r"><code># Use &quot;which&quot; to select specific variables
plot(out.2.2, log=&quot;x&quot;,type=&quot;b&quot;, which = c(&quot;y1&quot;, &quot;y2&quot;, &quot;y3&quot;))</code></pre>
<p><img src="/post/2018-03-09-mcsim-under-r-windows_files/figure-html/unnamed-chunk-5-2.png" width="672" /></p>
</div>
</div>
<div id="compile-the-mcsim-model-file-and-solve-by-mcsim" class="section level1">
<h1><span class="header-section-number">2</span> Compile the MCSim model file and solve by MCSim</h1>
<div id="prepare-in-file" class="section level2">
<h2><span class="header-section-number">2.1</span> Prepare in file</h2>
<p>In this part, we need to put <code>simple.in</code> file in the working directory. The in file define the initial and parameter values, respectively. Also,we need to set the output time steps and intervals. The source code looks like this:</p>
<pre><code>#------------------------------------------------------------------------------
# the deSolve example model run with GNU MCSim (simple.in)
#------------------------------------------------------------------------------

Integrate (Lsodes, 1E-7, 1E-7, 1);

Simulation {

  y0 = 1;

  # Parameters
  k1 = 0.04;
  k2 = 1e4;
  k3 = 3e7;

  Print (y0, 0, 4e-1, 4e+0, 4e+1, 4e+2, 4e+3, 4e+4, 4e+5, 4e+6, 4e+7, 4e+8, 
         4e+9, 4e+10);
  Print (y1, 0, 4e-1, 4e+0, 4e+1, 4e+2, 4e+3, 4e+4, 4e+5, 4e+6, 4e+7, 4e+8, 
         4e+9, 4e+10);
  Print (y2, 0, 4e-1, 4e+0, 4e+1, 4e+2, 4e+3, 4e+4, 4e+5, 4e+6, 4e+7, 4e+8, 
         4e+9, 4e+10);

  Print (yout, 0, 4e-1, 4e+0, 4e+1, 4e+2, 4e+3, 4e+4, 4e+5, 4e+6, 4e+7, 4e+8, 
         4e+9, 4e+10);

}

End.</code></pre>
<p>The following step compile the <code>simple.model</code> file and create the executable program named <code>mcsim.simple.model.exe</code>.</p>
<pre class="r"><code># set the name of your model
mName = &quot;simple.model&quot;

# Your model executable can be linked with the GNU Scientific Library (GSL, recommended). 
# If you have GSL installed the directives &#39;#define HAVE_LIBGSL 1&#39; and &#39;#define HAVE_LIBGSLCBLAS 1&#39; should appear in the config.h file, in the directory above this one.
# If it does not, put them in, alone at the beginning of a line.  
# If you do NOT have libGSL, those directives should NOT appear in that file. 
# If they do, delete them.

libGSL = &quot;&quot; # libGSL = &quot;-lgsl -lgslcblas&quot; 
# uncomment and execute if you have the GNU Scientific Library


system(paste(&quot;./mod/mod.exe &quot;, mName, &quot; &quot;, mName, &quot;.c&quot;, sep = &quot;&quot;)) 
# Unlike above exercice, you need to remove the -R flag that can only create c file.</code></pre>
<p>Compile the “simple.model.c” to “mcsim.simple.model.exe”. Copy the “sim” file in MCSim folder and put in your working directory. Also copy the <code>config.h</code> file and put in the “sim” folder.</p>
<pre class="r"><code>system(paste(&quot;gcc -O3 -I.. -I./sim -o mcsim_&quot;, mName, &quot;.exe &quot;, mName, &quot;.c ./sim/*.c -lm &quot;, libGSL, sep = &quot;&quot;))

# run the simulation input file
# put its name here
simName = &quot;simple.in&quot;

# run!
system(paste(&quot;./mcsim_&quot;, mName, &quot;.exe &quot;, simName, sep = &quot;&quot;))

# the output file is called out by default, load it
out.3 &lt;- read.delim(&quot;sim.out&quot;, skip = 2)

head (out.3)</code></pre>
<pre><code>##    Time       y0          y1        y2 yout
## 1 0e+00 1.000000 0.00000e+00 0.0000000    1
## 2 4e-01 0.985172 3.38640e-05 0.0147937    1
## 3 4e+00 0.905519 2.24048e-05 0.0944587    1
## 4 4e+01 0.715827 9.18554e-06 0.2841640    1
## 5 4e+02 0.450518 3.22290e-06 0.5494790    1
## 6 4e+03 0.183203 8.94241e-07 0.8167960    1</code></pre>
<pre class="r"><code># look

lo = layout(t(matrix(1:4, ncol = 2)), respect = TRUE)
plot(out.3[,1], out.3[,2], log=&quot;x&quot;,type=&quot;b&quot;, xlab = &quot;time&quot;, ylab = &quot;&quot;, main = &quot;y1&quot;)
plot(out.3[,1], out.3[,3], log=&quot;x&quot;,type=&quot;b&quot;, xlab = &quot;time&quot;, ylab = &quot;&quot;, main = &quot;y2&quot;)
plot(out.3[,1], out.3[,4], log=&quot;x&quot;,type=&quot;b&quot;, xlab = &quot;time&quot;, ylab = &quot;&quot;, main = &quot;y3&quot;)</code></pre>
<p><img src="/post/2018-03-09-mcsim-under-r-windows_files/figure-html/unnamed-chunk-7-1.png" width="672" /></p>
</div>
</div>
